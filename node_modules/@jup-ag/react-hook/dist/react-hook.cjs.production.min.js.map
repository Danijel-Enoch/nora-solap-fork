{"version":3,"file":"react-hook.cjs.production.min.js","sources":["../src/error.tsx","../src/index.tsx","../src/utils/useDebounce.ts"],"sourcesContent":["export const Errors = {\n  INITIALIZE_ERROR: 'INITIALIZE_ERROR' as 'INITIALIZE_ERROR',\n  ROUTES_ERROR: 'ROUTES_ERROR' as 'ROUTES_ERROR',\n};\n","import React, { useEffect, useState, useMemo, useCallback, useRef, createContext, useContext } from 'react';\nimport { Connection, PublicKey, Cluster } from '@solana/web3.js';\nimport { Errors } from './error';\nimport type { SignerWalletAdapter } from '@solana/wallet-adapter-base';\nimport useDebounce from './utils/useDebounce';\nimport {\n  RouteInfo,\n  Jupiter,\n  SwapResult,\n  TOKEN_LIST_URL,\n  MARKETS_URL,\n  JUPITER_ERRORS,\n  TransactionFeeInfo,\n  getRouteInfoUniqueId,\n  PlatformFeeAndAccounts,\n  QuoteMintToReferrer,\n  IConfirmationTxDescription,\n  OnTransaction,\n} from '@jup-ag/core';\n\nexport type JupiterError = typeof Errors[keyof typeof Errors];\nexport type { IConfirmationTxDescription };\n\ninterface UseJupiterResult {\n  /** routes that are possible, sorted decending based on outAmount */\n  routes?: RouteInfo[];\n  /** exchange function to submit transaction */\n  exchange: (params: {\n    wallet: Pick<SignerWalletAdapter, 'signAllTransactions' | 'publicKey' | 'sendTransaction' | 'signTransaction'>;\n    routeInfo: RouteInfo;\n    /** a confirmation waiter factory to make a confirmation waiter for each transaction */\n    onTransaction?: OnTransaction;\n  }) => Promise<SwapResult>;\n  /** refresh function to refetch the prices */\n  refresh: () => void;\n  /** last refresh timestamp */\n  lastRefreshTimestamp: number;\n  /** all possible token mints to be chosen from */\n  allTokenMints: string[];\n  /** route map input mint with output mints */\n  routeMap: Map<string, string[]>;\n  /** loading state */\n  loading: boolean;\n  error: JupiterError | undefined;\n}\n\ninterface JupiterProps {\n  connection: Connection;\n  cluster: Cluster;\n  userPublicKey?: PublicKey;\n  platformFeeAndAccounts?: PlatformFeeAndAccounts;\n  quoteMintToReferrer?: QuoteMintToReferrer;\n  routeCacheDuration?: number;\n  onlyDirectRoutes?: boolean;\n  /* custom jupiter market url */\n  marketUrl?: string;\n  restrictIntermediateTokens?: boolean;\n}\n\nconst JupiterContext = createContext<\n  | (Pick<UseJupiterResult, 'allTokenMints' | 'routeMap'> & {\n      connection: Connection;\n      cluster: string;\n      jupiter: Jupiter | undefined;\n      error: JupiterError | undefined;\n      setError: (error?: JupiterError) => void;\n      routeCacheDuration?: number;\n      onlyDirectRoutes?: boolean;\n    })\n  | null\n>(null);\n\nexport const JupiterProvider: React.FC<JupiterProps> = ({\n  connection,\n  cluster,\n  userPublicKey,\n  children,\n  platformFeeAndAccounts,\n  quoteMintToReferrer,\n  routeCacheDuration,\n  marketUrl,\n  restrictIntermediateTokens,\n  onlyDirectRoutes,\n}) => {\n  const [jupiter, setJupiter] = useState<Jupiter>();\n\n  const [error, setError] = useState<JupiterError>();\n\n  useEffect(() => {\n    (async () => {\n      try {\n        const _jupiter = await Jupiter.load({\n          connection,\n          cluster,\n          user: userPublicKey,\n          platformFeeAndAccounts,\n          routeCacheDuration,\n          quoteMintToReferrer,\n          marketUrl,\n          restrictIntermediateTokens,\n        });\n\n        setJupiter(_jupiter);\n      } catch (e) {\n        console.error(e);\n        setError(Errors.INITIALIZE_ERROR);\n        throw e;\n      }\n    })();\n  }, [connection, cluster, restrictIntermediateTokens]);\n\n  useEffect(() => {\n    if (jupiter && userPublicKey) {\n      jupiter.setUserPublicKey(userPublicKey);\n    }\n  }, [jupiter, userPublicKey]);\n\n  const routeMap = useMemo(() => {\n    let routeMap = new Map<string, string[]>();\n\n    if (jupiter) {\n      routeMap = jupiter.getRouteMap(onlyDirectRoutes);\n    }\n    return routeMap;\n  }, [jupiter, onlyDirectRoutes]);\n\n  const allTokenMints = useMemo(() => {\n    return Array.from(routeMap.keys());\n  }, [routeMap]);\n\n  return (\n    <JupiterContext.Provider\n      value={{\n        jupiter,\n        allTokenMints,\n        connection,\n        cluster,\n        routeMap,\n        error,\n        setError,\n        routeCacheDuration,\n        onlyDirectRoutes,\n      }}\n    >\n      {children}\n    </JupiterContext.Provider>\n  );\n};\n\ninterface UseJupiterProps {\n  amount: number;\n  inputMint: PublicKey | undefined;\n  outputMint: PublicKey | undefined;\n  slippage: number;\n  /* inputAmount is being debounced, debounceTime 0 to disable debounce */\n  debounceTime?: number;\n}\n\nexport const useJupiterRouteMap = () => {\n  const context = useContext(JupiterContext);\n  if (!context) {\n    throw new Error('JupiterProvider is required');\n  }\n  return context.routeMap;\n};\n\nexport const useJupiter = ({\n  amount,\n  inputMint,\n  outputMint,\n  slippage,\n  debounceTime = 250,\n}: UseJupiterProps): UseJupiterResult => {\n  const context = useContext(JupiterContext);\n  const [loading, setLoading] = useState(false);\n  const [routes, setRoutes] = useState<RouteInfo[]>();\n  const [refreshCount, setRefreshCount] = useState<number>(0);\n  // lastRefreshCount indicate when the last refresh was triggered on which refreshCount\n  const lastRefreshCount = useRef<number>(refreshCount);\n\n  const [debouncedAmount, debouncedInputMint, debouncedOutputMint] = useDebounce(\n    React.useMemo(() => [amount, inputMint, outputMint], [amount, inputMint?.toBase58(), outputMint?.toBase58()]),\n    debounceTime,\n  );\n\n  const lastRefreshTimestamp = useRef<number>(0);\n  const lastQueryTimestamp = useRef<number>(0);\n\n  if (!context) {\n    throw new Error('JupiterProvider is required');\n  }\n\n  const { routeMap, allTokenMints, jupiter, error, setError, routeCacheDuration = 0, onlyDirectRoutes } = context;\n\n  // lastRefreshCount to determine when the last refresh was triggered, reset this to -1 to trigger a re-fetch\n  useEffect(() => {\n    lastRefreshCount.current = -1;\n  }, [[debouncedInputMint?.toString(), debouncedOutputMint?.toString()].sort().join('-'), slippage]);\n\n  useEffect(() => {\n    // if now - lastRefreshTimestamp > routeCacheDuration, then we need to refresh\n    if (lastRefreshTimestamp.current && new Date().getTime() - lastRefreshTimestamp.current >= routeCacheDuration) {\n      lastRefreshCount.current = -1;\n    }\n\n    if (debouncedAmount && refreshCount !== lastRefreshCount.current) {\n      // don't set loading if there is no input amount\n      setLoading(true);\n    }\n  }, [refreshCount, debouncedAmount, slippage, debouncedInputMint, debouncedOutputMint, onlyDirectRoutes]);\n\n  useEffect(() => {\n    if (!jupiter) {\n      return;\n    }\n\n    if (!debouncedAmount || error === Errors.INITIALIZE_ERROR) {\n      setRoutes(undefined);\n    } else if (debouncedAmount) {\n      if (!debouncedInputMint || !debouncedOutputMint || !routeMap) return;\n      let lastUpdatedTime = new Date().getTime();\n      lastQueryTimestamp.current = lastUpdatedTime;\n\n      jupiter\n        .computeRoutes({\n          inputMint: debouncedInputMint,\n          outputMint: debouncedOutputMint,\n          inputAmount: debouncedAmount,\n          slippage,\n          forceFetch: refreshCount !== lastRefreshCount.current,\n          onlyDirectRoutes,\n        })\n        .then(({ routesInfos, cached }) => {\n          if (lastQueryTimestamp.current !== lastUpdatedTime) {\n            return;\n          }\n          setRoutes(routesInfos);\n          setError(undefined);\n\n          if (!cached) {\n            lastRefreshTimestamp.current = new Date().getTime();\n          }\n        })\n        .catch((e) => {\n          console.error(e);\n          if (lastQueryTimestamp.current !== lastUpdatedTime) {\n            return;\n          }\n          // Clear routes when erring to avoid bad pricing\n          setRoutes(undefined);\n          setError(Errors.ROUTES_ERROR);\n        })\n        .finally(() => {\n          if (lastQueryTimestamp.current !== lastUpdatedTime) {\n            return;\n          }\n          lastRefreshCount.current = refreshCount;\n          setLoading(false);\n        });\n    }\n  }, [jupiter, debouncedAmount, debouncedInputMint, debouncedOutputMint, slippage, refreshCount, onlyDirectRoutes]);\n\n  const exchange: UseJupiterResult['exchange'] = useCallback(\n    async ({ wallet, routeInfo, onTransaction }): Promise<SwapResult> => {\n      if (error) {\n        throw new Error(error);\n      }\n\n      if (!jupiter) {\n        throw new Error('Jupiter not initialized');\n      }\n\n      if (!wallet?.publicKey) {\n        throw new Error('Wallet not connected');\n      }\n\n      if (!routeInfo) {\n        throw new Error('Invalid state, impossible to build transaction');\n      }\n\n      const { execute } = await jupiter.exchange({ routeInfo });\n\n      const result = await execute({ wallet, onTransaction });\n\n      return result;\n    },\n    [jupiter],\n  );\n\n  return {\n    allTokenMints,\n    routeMap,\n    exchange,\n    refresh: () => {\n      if (!loading && lastRefreshTimestamp.current) {\n        setRefreshCount((refreshCount) => refreshCount + 1);\n      }\n    },\n    lastRefreshTimestamp: lastRefreshTimestamp.current,\n    loading,\n    routes,\n    error,\n  };\n};\n\nexport { RouteInfo, getRouteInfoUniqueId, TOKEN_LIST_URL, JUPITER_ERRORS, MARKETS_URL, Errors, TransactionFeeInfo };\n","import { useEffect, useState } from 'react';\n\nexport default function useDebounce(value: any, delay: number) {\n  const [debouncedValue, setDebouncedValue] = useState(value);\n  useEffect(\n    () => {\n      // Update debounced value after delay\n      const handler = setTimeout(() => {\n        setDebouncedValue(value);\n      }, delay);\n      // Cancel the timeout if value changes (also on delay change or unmount)\n      return () => {\n        clearTimeout(handler);\n      };\n    },\n    [value, delay], // Only re-call effect if value or delay changes\n  );\n  return debouncedValue;\n}\n"],"names":["Errors","INITIALIZE_ERROR","ROUTES_ERROR","JupiterContext","createContext","connection","cluster","userPublicKey","children","platformFeeAndAccounts","quoteMintToReferrer","routeCacheDuration","marketUrl","restrictIntermediateTokens","onlyDirectRoutes","jupiter","setJupiter","useState","error","setError","routeMap","useEffect","_jupiter","Jupiter","load","user","e","console","setUserPublicKey","useMemo","let","Map","getRouteMap","allTokenMints","Array","from","keys","React","createElement","Provider","value","amount","inputMint","outputMint","slippage","debounceTime","context","useContext","loading","setLoading","routes","setRoutes","refreshCount","setRefreshCount","lastRefreshCount","useRef","debouncedAmount","debouncedInputMint","debouncedOutputMint","delay","debouncedValue","setDebouncedValue","handler","setTimeout","clearTimeout","toBase58","lastRefreshTimestamp","lastQueryTimestamp","Error","current","toString","sort","join","Date","getTime","lastUpdatedTime","computeRoutes","inputAmount","forceFetch","then","routesInfos","cached","catch","finally","exchange","useCallback","async","wallet","routeInfo","onTransaction","publicKey","execute","refresh"],"mappings":"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"}